"use strict";class t{constructor(t){this.calculatedEnd=0,this.msLeft=0,this.running=!1,this.stopRequested=!1,this.pauseRequested=!1,this.notifyPoints=[],this.msLeft=t,this.lastDuration=t}addNotifyPoint(t,e){this.notifyPoints.push({msLeft:t,pointID:e,triggered:!1})}stop(){this.stopRequested=!0,this.msLeft=0,this.setDuration(this.lastDuration)}reschedule(){this.calculatedEnd=performance.now()+this.msLeft;for(const t of this.notifyPoints)t.triggered=t.msLeft>=this.msLeft}toggle(){return this.running?(this.pauseRequested=!0,e.Paused):(this.running=!0,this.pauseRequested=!1,this.stopRequested=!1,this.reschedule(),e.Continue)}tick(){let t=Math.max(this.calculatedEnd-performance.now(),0);const s=[];for(const e of this.notifyPoints)t<=e.msLeft&&!e.triggered&&(e.triggered=!0,s.push(e));return t<=0?(this.running=!1,this.msLeft=0,[e.Elapsed,s]):this.stopRequested?(this.running=!1,[e.Stopped,s]):this.pauseRequested?(this.running=!1,this.msLeft=t,[e.Paused,s]):(this.msLeft=t,[e.Continue,s])}get canStop(){return(this.running||this.msLeft>0)&&this.msLeft!==this.lastDuration}get canToggle(){return this.running||this.msLeft>0}setDuration(t){this.msLeft=t,this.lastDuration=t,this.reschedule()}}var e;!function(t){t[t.Continue=0]="Continue",t[t.Stopped=1]="Stopped",t[t.Paused=2]="Paused",t[t.Elapsed=3]="Elapsed"}(e||(e={}));function s(t){return new Promise(((e,s)=>{function i(){t.removeEventListener("ended",i),e()}t.addEventListener("ended",i),t.play().catch((t=>{removeEventListener("ended",i),s(t)}))}))}const i=[[3e4,"30 seconds left","30s"],[6e4,"1 minute left","1m"],[3e5,"5 minutes left","5m"],[6e5,"10 minutes left","10m"],[18e5,"30 minutes left","30m"]];function n(t){setTimeout(t,10)}function o(t,e=!0){let s=(""+Math.floor(t/36e5)).padStart(2,"0"),i=(""+Math.floor(t/6e4%60)).padStart(2,"0"),n=(""+Math.floor(t/1e3)%60).padStart(2,"0"),o=(""+Math.floor(t%1e3/10)).padStart(2,"0");return e?`${s}:${i}:${n}.${o}`:`${s}:${i}:${n}`}function r(t){let e=1;switch(t.slice(-1)){case"s":e=1e3;break;case"m":e=6e4;break;case"h":e=36e5}let s=parseInt(t);return isNaN(s)?0:s*e}function a(t){let e=t.indexOf(".");if(e<0)return{parsed:void 0,success:!1};let s=t.slice(e+1);if(2!==s.length)return{parsed:void 0,success:!1};let i=u(s);if(null==i)return{parsed:void 0,success:!1};let n=t.slice(0,e).split(":");if(n.some((t=>t.length>2)))return{parsed:void 0,success:!1};let o=n.map((t=>u(t))).reverse();if(o.some((t=>null==t||t>=60)))return{parsed:void 0,success:!1};if(o.length>3||o.length<1)return{parsed:void 0,success:!1};let r=o,a=10*i+1e3*r[0];return r.length>=2&&(a+=1e3*r[1]*60),r.length>=3&&(a+=1e3*r[2]*60*60),{parsed:a,success:!0}}function u(t){return/^[0-9]+$/.test(t)?+t:void 0}new class{constructor(){const t=matchMedia("(prefers-color-scheme: dark)");this.currentSystemThemeIsDark=t.matches,t.addEventListener("change",(t=>{this.currentSystemThemeIsDark=t.matches,console.log(this.currentTheme),"auto"===this.currentTheme&&this.setTheme("auto")}));const e=localStorage.getItem("theme-selected");"auto"!==e&&e?(this.setTheme(e),this.setThemeSelectorValue(e)):(this.setTheme("auto"),this.setThemeSelectorValue("auto"));const s=document.querySelector("[name=color_theme]");s&&s.addEventListener("change",(t=>{t.target&&this.onThemeSwitch(t.target.value)}))}setTheme(t){const e="auto"===t?this.getCurrentDefaultTheme():t;document.documentElement.classList.forEach((t=>{t.startsWith("theme--")&&document.documentElement.classList.remove(t)})),document.documentElement.classList.add(`theme--${e}`),this.currentTheme=t}setThemeSelectorValue(t){const e=document.querySelector("select[name=color_theme]");e&&(e.value=t)}getCurrentDefaultTheme(){const t=localStorage.getItem("light-theme")||"light",e=localStorage.getItem("dark-theme")||"dark";return this.currentSystemThemeIsDark?e:t}onThemeSwitch(t){if(this.setTheme(t),"auto"!==t){const e=this.isThemeDark(t);localStorage.setItem(e?"dark-theme":"light-theme",t)}localStorage.setItem("theme-selected",t)}isThemeDark(t){const e=document.querySelector(`select[name=color_theme] option[value=${t}]`);if(!e)throw new Error(`Theme ${t} not found`);const s=e.dataset.isDark;if("true"!==s&&"false"!==s)throw new Error(`Configuration for theme ${t} is invalid: data-is-dark is missing`);return JSON.parse(s)}},new class{constructor(e){this.isInputDirty=!1,this.isInputValid=!0,this.voiceNotifier=e,this.counter=new t(6e5);for(const t of i){const e=this.voiceNotifier.prepareNotification(t[1],`voice/${t[2]}.mp3`);this.counter.addNotifyPoint(t[0],e)}const s=matchMedia("(prefers-reduced-motion: reduce)");s.addEventListener("change",(t=>{this.reducedMotion=t.matches})),this.reducedMotion=s.matches,this.input=document.querySelector("#timer-input"),this.input.addEventListener("blur",this.applyInputValue.bind(this)),this.input.addEventListener("input",this.onInputChange.bind(this)),this.input.addEventListener("keydown",this.onInputKeydown.bind(this)),this.inputContainer=document.querySelector(".timer-input"),this.progress=document.querySelector("#progress-bar"),window.onbeforeunload=this.onBeforeUnload.bind(this),this.updateTimeDisplay(),document.body.addEventListener("click",(t=>{let e=t.target;if(e instanceof HTMLElement)if(e.classList.contains("template-button__set")){let t=e.parentElement.dataset.template;t&&this.onChangeTemplate(t)}else if(e.classList.contains("template-button__inc")){let t=e.parentElement.dataset.template;t&&this.onIncTemplate(t)}else e.classList.contains("stop")?this.onStop():e.classList.contains("toggle")&&this.onToggle()}))}onBeforeUnload(t){return this.counter.canStop?(t.preventDefault(),"Please don't"):void 0}onInputChange(t){this.isInputDirty=!0}onInputKeydown(t){let e;if("ArrowUp"===t.key)e=6e4;else{if("ArrowDown"!==t.key)return;e=-6e4}let{parsed:s,success:i}=a(this.input.value);if(!i||null==s)return;const n=this.input.selectionStart,r=this.input.selectionEnd;let u=s+e;u<0&&(u=0),this.input.value=o(this.reducedMotion?1e3*Math.ceil(u/1e3):u),this.isInputDirty=!0,this.input.selectionStart=n,this.input.selectionEnd=r,t.preventDefault()}applyInputValue(){if(!this.isInputDirty)return;let{parsed:t,success:e}=a(this.input.value);this.setValidationStatus(e),this.isInputDirty=!1,null!=t&&(this.counter.setDuration(t),this.updateState())}setValidationStatus(t){t!==this.isInputValid&&(this.isInputValid=t,this.input.classList.toggle("timer-input__time--invalid",!t))}onStop(){this.counter.stop(),this.updateTimeDisplay()}onToggle(){if(!this.isInputValid)return;this.counter.toggle()===e.Continue&&n(this.onTimerIteration.bind(this))}onChangeTemplate(t){this.counter.setDuration(r(t)),this.updateTimeDisplay()}onIncTemplate(t){const e=this.counter.msLeft+r(t);e>215999990||(this.counter.setDuration(e),this.updateTimeDisplay())}onTimerIteration(){let[t,i]=this.counter.tick();switch(this.updateTimeDisplay(),t){case e.Elapsed:!async function(t=2){let e=document.getElementById("beep-sound");if(e&&e instanceof HTMLAudioElement)for(let i=0;i<t;++i)await s(e)}();break;case e.Continue:n(this.onTimerIteration.bind(this))}for(const t of i)this.voiceNotifier.notifyByID(t.pointID)}updateTimeDisplay(){let t=this.counter.msLeft;this.input.value=o(this.reducedMotion?1e3*Math.ceil(t/1e3):t),this.isInputDirty=!1,this.setValidationStatus(!0);let e=t/this.counter.lastDuration*100;this.reducedMotion&&(e=+e.toFixed(1)),this.progress.style.width=`${e}%`,document.title=t>0?`${o(t,!1)} - Timer`:"Timer",this.updateState()}updateState(){let t=document.querySelector(".toggle");t&&(t.textContent=this.counter.running?"Pause":"Start",t.disabled=!this.counter.canToggle,t.classList.toggle("primary-active",this.counter.canToggle&&!this.counter.running));let e=document.querySelector(".stop");e&&(e.disabled=!this.counter.canStop),this.input.readOnly=this.counter.running,this.inputContainer.classList.toggle("timer-input--live",this.counter.running)}}(new class{constructor(){this.hasSpeechSynthesis=this.getHasSpeechSynthesis(),this.notifications=new Map}getHasSpeechSynthesis(){return window.SpeechSynthesisUtterance&&window.speechSynthesis&&0!==speechSynthesis.getVoices().length}prepareNotification(t,e){const s=function(t){return"voice-"+t.replace(/[^a-z0-9]/gi,"_")}(t);return this.notifications.set(s,t),this.hasSpeechSynthesis||null!=document.getElementById(s)||this.createAudioElement(e,s),s}createAudioElement(t,e){const s=document.createElement("audio");return s.id=e,s.src=t,s.preload="auto",document.body.appendChild(s),s}async notifyByID(t){const e=this.notifications.get(t);if(!e)throw new Error("No voice notification registered for id: "+t);if(this.hasSpeechSynthesis){let t=new SpeechSynthesisUtterance(e);t.lang="en-US",window.speechSynthesis.speak(t)}let i=document.getElementById(t);if(null==i)throw new Error("No audio element found for id: "+t);return s(i)}});
